var Poust;!function(a){var b=function(){function a(a){this._element=a,this._started=!1,this._stateListener=null}return a.prototype.setStateListener=function(a){this._stateListener=a},a.prototype.init=function(){this._element.setAttribute("class","")},a.prototype.start=function(){this._started=!0},a.prototype.stop=function(){this._started=!1},a.prototype.destroy=function(){this._element.setAttribute("class","hidden")},a.prototype.isStarted=function(){return this._started},a.prototype.fireStateChangeEvent=function(a){this._stateListener&&this._stateListener(this,a)},a}();a.AbstractState=b}(Poust||(Poust={}));var __extends=this&&this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},Poust;!function(a){var b=function(a){function b(b){var c=this;a.call(this,b),this._animationFrameCallback=function(a){if(c.isStarted()){if(null!=c._lastUpdateMillis){var b=a-c._lastUpdateMillis;b>0&&200>b&&(c.update(b),c.render())}c._lastUpdateMillis=a,requestAnimationFrame(c._animationFrameCallback)}else c._lastUpdateMillis=null}}return __extends(b,a),b.prototype.start=function(){a.prototype.start.call(this),requestAnimationFrame(this._animationFrameCallback)},b.prototype.stop=function(){a.prototype.stop.call(this)},b.prototype.update=function(a){},b.prototype.render=function(){},b}(a.AbstractState);a.AbstractUpdatingState=b}(Poust||(Poust={}));var Poust;!function(a){var b;!function(b){var c=function(){function b(a){this._groupId=a,this._dead=!1,this._sensor=!1,this._continuousCollisions=!1}return b.prototype.getGroupId=function(){return this._groupId},b.prototype.getBounds=function(){return this._bounds},b.prototype.getVelocityRadiusPX=function(){return 0},b.prototype.setVelocityRadiusPX=function(a){},b.prototype.getVelocityAngleRadians=function(a){return 0},b.prototype.setVelocityAngleRadians=function(a,b){},b.prototype.setAnchorRight=function(a){},b.prototype.getMass=function(){return null},b.prototype.calculateMotion=function(b){return new a.Level.Motion.SimpleMotion(this.getBounds(),this)},b.prototype.notifyCollision=function(a,b){},b.prototype.update=function(a,b){},b.prototype.isDead=function(){return this._dead},b.prototype.setDead=function(){this._dead=!0},b.prototype.isSensor=function(){return this._sensor},b.prototype.setSensor=function(a){this._sensor=a},b.prototype.isContinuousCollisions=function(){return this._continuousCollisions},b}();b.AbstractEntity=c}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(b){var c=function(c){function d(a,b,d,e){c.call(this,a),this._widthPX=b,this._mass=d,this._respectsGravity=e,this._velocityAPX=0,this._velocityRPX=0,this._anchorRight=!1}return __extends(d,c),d.prototype.setVelocity=function(a,b){this._velocityRPX=a,this._velocityAPX=b},d.prototype.getVelocityRadiusPX=function(){return this._velocityRPX},d.prototype.setVelocityRadiusPX=function(a){this._velocityRPX=a},d.prototype.getVelocityAngleRadians=function(a){return this._velocityAPX/a},d.prototype.setVelocityAngleRadians=function(a,b){this._velocityAPX=a*b},d.prototype.setAnchorRight=function(a){this._anchorRight!=a&&(this._anchorRight=a)},d.prototype.getMass=function(){return this._mass},d.prototype.calculateMotion=function(c){var d,e=this.getBounds(),f=this._velocityRPX*c,g=this._velocityAPX*c,h=e.getInnerRadiusPx()+f,i=g/h,j=this._widthPX/h;d=this._anchorRight?e.getEndAngleRadians()-j:e.getStartAngleRadians(),d+=i;var k=new b.PolarBounds(h,d,e.getHeightPx(),j);return k.normalize(),new a.Level.Motion.SimpleMotion(k,this)},d.prototype.update=function(a,b){c.prototype.update.call(this,a,b),this._respectsGravity&&(this._velocityRPX-=b*(a.getGravity()/(Math.abs(this._velocityAPX)+1)))},d}(b.AbstractEntity);b.AbstractPolarEntity=c}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b=function(){function a(a,b,c,d,e,f,g,h,i){this.sensorCollision=a,this.collisionTime=b,this.nearestCollisionIntersection=c,this.entityHolder1=d,this.bestMotion1=e,this.collisionMotion1=f,this.entityHolder2=g,this.bestMotion2=h,this.collisionMotion2=i}return a}();a.Collision=b}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b;!function(b){var c=function(c){function d(a,b,d,e){c.call(this,a,b,d,!0),this._jumpPower=e,this._runningRight=!0,this._targets={},this._continuousCollisions=!0}return __extends(d,c),d.prototype.setTarget=function(a,c,d,e){var f=this._targets[a];null==f&&(e&&(this._onGround?f=new b.PlayerEntityTarget(!0,c,d):this._onLeftWall?f=new b.PlayerEntityTarget(!0,c,d):this._onRightWall&&(f=new b.PlayerEntityTarget(!0,c,d))),this._targets[a]=f)},d.prototype.copyTargets=function(){var a={};for(var b in this._targets)a[b]=this._targets[b];return a},d.prototype.clearTarget=function(a){delete this._targets[a]},d.prototype.setJump=function(){this._targets[d.JUMP_INPUT_ID]=new b.PlayerEntityTarget(!0,null,null)},d.prototype.clearJump=function(){delete this._targets[d.JUMP_INPUT_ID]},d.prototype.notifyCollision=function(b,c){c==a.PolarEdge.Bottom?this._onGround=!0:c==a.PolarEdge.Right?this._onRightWall=!0:c==a.PolarEdge.Left&&(this._onLeftWall=!0)},d.prototype.update=function(a,b){c.prototype.update.call(this,a,b);var d=null;for(var e in this._targets){var f=this._targets[e];if(null!=f&&f.jumping&&!f.jumped){d=f;break}}if(this._onGround){this._onRightWall?this._runningRight=!1:this._onLeftWall&&(this._runningRight=!0);var g;g=this._runningRight?1e-4:-1e-4,this._velocityAPX+=g*b,d&&(this._velocityRPX=this._jumpPower,d.jumped=!0)}else if(d?this._onRightWall?(this._runningRight=!1,this._velocityRPX=this._jumpPower,this._velocityAPX=-this._jumpPower,d.jumped=!0):this._onLeftWall&&(this._runningRight=!0,this._velocityRPX=this._jumpPower,this._velocityAPX=this._jumpPower,d.jumped=!0):(g=this._onRightWall?.001:this._onLeftWall?-.001:0,this._velocityAPX+=g*b),this._velocityRPX>0)for(var e in this._targets){var f=this._targets[e];if(null!=f&&f.jumping&&f.jumped){this._velocityRPX+=3e-4*b;break}}this._onGround=!1,this._onRightWall=!1,this._onLeftWall=!1},d.JUMP_INPUT_ID=-1,d}(a.AbstractPolarEntity);b.PlayerEntity=c}(b=a.Entity||(a.Entity={}))}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b;!function(a){var b=function(){function a(a,b,c){this.jumping=a,this.r=b,this.a=c}return a}();a.PlayerEntityTarget=b}(b=a.Entity||(a.Entity={}))}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b=function(){function a(a,b){this.entity=a,this.renderer=b}return a}();a.EntityHolder=b}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){!function(a){a[a.Player=0]="Player",a[a.Enemy=1]="Enemy",a[a.Terrain=2]="Terrain"}(a.GroupId||(a.GroupId={}));a.GroupId}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(b){var c=function(a){function c(b,c,d,e,f,g){var h=this;a.call(this,b),this._player=c,this._gravity=d,this._context=e,this._defaultRenderer=f,this._maxCollisionSteps=g,this._groups=new Array,this._touchStartListener=function(a){for(var b in a.changedTouches){var c=a.changedTouches.item(b);h.setTarget(c.identifier,c.clientX,c.clientY,!0)}},this._touchEndListener=function(a){for(var b in a.changedTouches){var c=a.changedTouches.item(b);h.clearTarget(c.identifier)}},this._touchMoveListener=function(a){for(var b in a.changedTouches){var c=a.changedTouches.item(b);h.setTarget(c.identifier,c.clientX,c.clientY,!0)}};var i=!1;this._mouseDownListener=function(a){h.setTarget(0,a.clientX,a.clientY,!1),i=!0},this._mouseMoveListener=function(a){i&&h.setTarget(0,a.clientX,a.clientY,!1)},this._mouseUpListener=function(a){h.clearTarget(0),i=!1},this._keyDownListener=function(a){(a["char"]=" ")&&h._player.setJump()},this._keyUpListener=function(a){(a["char"]=" ")&&h._player.clearJump()}}return __extends(c,a),c.prototype.setTarget=function(a,b,c,d){var e=this._element.clientWidth,f=this._element.clientHeight,g=e/2-b,h=f/2-c,i=Math.atan2(h,g),j=Math.sqrt(g*g+h*h),k=i;this._player.setTarget(a,j,k,d)},c.prototype.clearTarget=function(a){this._player.clearTarget(a)},c.prototype.start=function(){a.prototype.start.call(this),"ontouchstart"in window||window.DocumentTouch?(this._element.addEventListener("touchstart",this._touchStartListener),this._element.addEventListener("touchmove",this._touchMoveListener),this._element.addEventListener("touchend",this._touchEndListener),this._element.addEventListener("touchleave",this._touchEndListener),this._element.addEventListener("touchcancel",this._touchEndListener)):(this._element.addEventListener("mousedown",this._mouseDownListener),this._element.addEventListener("mouseup",this._mouseUpListener),this._element.addEventListener("mousemove",this._mouseMoveListener)),window.addEventListener("keydown",this._keyDownListener),window.addEventListener("keyup",this._keyUpListener)},c.prototype.stop=function(){a.prototype.stop.call(this),this._element.removeEventListener("touchstart",this._touchStartListener),this._element.removeEventListener("touchmove",this._touchMoveListener),this._element.removeEventListener("touchend",this._touchEndListener),this._element.removeEventListener("touchleave",this._touchEndListener),this._element.removeEventListener("touchcancel",this._touchEndListener),this._element.removeEventListener("mousedown",this._mouseDownListener),this._element.removeEventListener("mouseup",this._mouseUpListener),this._element.removeEventListener("mousemove",this._mouseMoveListener),window.removeEventListener("keydown",this._keyDownListener),window.removeEventListener("keyup",this._keyUpListener)},c.prototype.getGravity=function(){return this._gravity},c.prototype.addEntity=function(a){for(var c=a.getGroupId();this._groups.length<=c;)this._groups.push(new Array);var d=this._groups[c],e=this._defaultRenderer;d.push(new b.EntityHolder(a,e))},c.prototype.update=function(a){this.updateMotion(a);var b=this.calculateCollisions(a);this.resolveCollisions(a,b),this.applyMotion()},c.prototype.resolveCollisions=function(a,c){for(var d=0;d<c.length;){var e,f,g=c[d],h=g.entityHolder1.entity,i=g.entityHolder2.entity,j=h.getMass(),k=i.getMass();if(g.sensorCollision||null==j&&null==k)e=b.PolarEdge.Undefined,f=b.PolarEdge.Undefined;else{var l=g.nearestCollisionIntersection.getCenterRadiusPx(),m=h.getVelocityRadiusPX(),n=i.getVelocityRadiusPX(),o=h.getVelocityAngleRadians(l),p=i.getVelocityAngleRadians(l),q=n-m,r=p-o;if(e=this.calculateCollisionEdge(q,r,g.collisionMotion1.getBounds(),g.nearestCollisionIntersection),f=this.calculateCollisionEdge(-q,-r,g.collisionMotion2.getBounds(),g.nearestCollisionIntersection),e==-f&&e!=b.PolarEdge.Undefined){if(e==b.PolarEdge.Top||e==b.PolarEdge.Bottom)if(null==j)i.setVelocityRadiusPX(m);else if(null==k)h.setVelocityRadiusPX(n);else{var s=(n*k+m*j)/(j+k);i.setVelocityRadiusPX(s),h.setVelocityRadiusPX(s)}else if(null==j)i.setVelocityAngleRadians(o,l);else if(null==k)h.setVelocityAngleRadians(p,l);else{var t=(p*k+o*j)/(j+k);i.setVelocityAngleRadians(t,l),h.setVelocityAngleRadians(t,l)}for(var u=d+1;u<c.length;){var v=c[u];v.entityHolder1==g.entityHolder1||v.entityHolder1==g.entityHolder2||v.entityHolder2==g.entityHolder1||v.entityHolder2==g.entityHolder2?c.splice(u,1):u++}g.bestMotion1.apply(),g.entityHolder1.motionOffset=g.collisionTime,g.bestMotion2.apply(),g.entityHolder2.motionOffset=g.collisionTime,e==b.PolarEdge.Left?h.setAnchorRight(!1):e==b.PolarEdge.Right&&h.setAnchorRight(!0),f==b.PolarEdge.Left?i.setAnchorRight(!1):f==b.PolarEdge.Right&&i.setAnchorRight(!0);var w=a-g.collisionTime;g.entityHolder1.motion=h.calculateMotion(w),g.entityHolder2.motion=i.calculateMotion(w),this.calculateCollisionsForEntity(a,c,g.entityHolder1,this._groups.length),this.calculateCollisionsForEntity(a,c,g.entityHolder2,this._groups.length)}else console.log("unmatched or undefined edges falling through!"),e=b.PolarEdge.Undefined,f=b.PolarEdge.Undefined}h.notifyCollision(i,e),i.notifyCollision(h,f),d++}},c.prototype.calculateCollisionEdge=function(a,c,d,e){var f,g=e.containsVertically(d.getInnerRadiusPx()),h=e.containsHorizontally(d.getStartAngleRadians()),i=e.getHeightPx();f=g?e.getOuterCircumferencePx():e.getInnerCircumferencePx();var j;return j=i>f||g&&0>=a||!g&&a>=0?h?c>0?b.PolarEdge.Left:b.PolarEdge.Undefined:0>c?b.PolarEdge.Right:b.PolarEdge.Undefined:g?b.PolarEdge.Bottom:b.PolarEdge.Top},c.prototype.calculateCollisionsForEntity=function(a,b,c,d){for(var e=(c.motion,c.entity),f=d;f>0;)if(f--,f!=e.getGroupId())for(var g=this._groups[f],h=g.length;h>0;){h--;var i=g[h],j=(i.motion,this.calculateCollision(a,c,i));if(null!=j){for(var k=0;k<b.length;){var l=b[k];if(l.collisionTime>j.collisionTime)break;k++}b.splice(k,0,j)}}},c.prototype.calculateCollisions=function(a){for(var b=new Array,c=this._groups.length;c>0;){c--;for(var d=this._groups[c],e=d.length;e>0;){e--;var f=d[e];this.calculateCollisionsForEntity(a,b,f,c)}}return b},c.prototype.calculateContinuousSamples=function(a,b){var c=1;if(b.entity.isContinuousCollisions())for(var d=!1;!d;){var e=a/c,f=b.entity.calculateMotion(e);f.getBounds().overlaps(b.entity.getBounds())?d=!0:c++}return c},c.prototype.calculateCollision=function(a,c,d){var e,f,g,h,i=c.entity,j=d.entity,k=c.motion,l=d.motion,m=this.calculateContinuousSamples(a,c),n=this.calculateContinuousSamples(a,d),o=Math.max(m,n);if(o>1){var p=1;for(h=null;o>=p;){var q=a*p/o,r=i.calculateMotion(q),s=j.calculateMotion(q);if(h=b.PolarBounds.intersect(r.getBounds(),s.getBounds()),null!=h){f=r,g=s,e=q;break}p++}}else f=k,g=l,e=a,h=b.PolarBounds.intersect(f.getBounds(),g.getBounds());var t;if(null!=h)if(c.entity.isSensor()||d.entity.isSensor()||c.entity.getBounds().overlaps(d.entity.getBounds()))t=new b.Collision(!0,a,h,c,f,g,d,l,l);else{for(var u=0,v=Math.max(c.motionOffset,d.motionOffset),w=e,x=h,y=null,z=null,A=f,B=g;u<this._maxCollisionSteps;){var C=(v+w)/2,D=c.entity.calculateMotion(C),E=d.entity.calculateMotion(C),F=b.PolarBounds.intersect(D.getBounds(),E.getBounds());null!=F?(w=C,x=F,A=D,B=E):(v=C,y=D,z=E),u++}null==y&&null==z&&(v=0,y=c.entity.calculateMotion(0),z=d.entity.calculateMotion(0)),t=new b.Collision(!1,v,x,c,y,A,d,z,B)}else t=null;return t},c.prototype.updateMotion=function(a){for(var b in this._groups){var c=this._groups[b];for(var d in c){var e=c[d],f=e.entity;f.update(this,a);var g=f.calculateMotion(a);e.motion=g,e.motionOffset=0}}},c.prototype.applyMotion=function(){for(var a in this._groups){var b=this._groups[a];for(var c in b){var d=b[c],e=d.motion;e.apply()}}},c.prototype.render=function(){var a=this._element.clientWidth,b=this._element.clientHeight;this._context.fillStyle="#000000",this._context.fillRect(0,0,a,b),this._context.save();var c=this._player.getBounds(),d=c.getCenterRadiusPx(),e=c.getCenterAngleRadians(),f=Math.sin(e),g=Math.cos(e),h=-d*g,i=-d*f;this._context.translate(a/2,b/2),this._context.translate(h,i);for(var j in this._groups)for(var k=this._groups[j],l=k.length;l>0;){l--;var m=k[l],n=m.entity,o=m.renderer;o.render(this._context,n)}this._context.restore()},c}(a.AbstractUpdatingState);b.LevelState=c}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b;!function(a){var b=function(){function a(a,b){this._bounds=a,this._entity=b}return a.prototype.getBounds=function(){return this._bounds},a.prototype.getEntity=function(){return this._entity},a.prototype.apply=function(){this._entity._bounds=this._bounds},a}();a.SimpleMotion=b}(b=a.Motion||(a.Motion={}))}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b=function(){function a(a,b,c,d){this._r=a,this._a=b,this._height=c,this._arc=d}return a.intersect=function(b,c){var d=b.permutate(),e=c.permutate();for(var f in d){var g=d[f];for(var h in e){var i=e[h],j=a.reallyIntersects(g,i);if(null!=j)return j.normalize(),j}}return null},a.reallyIntersects=function(b,c){var d=b.getInnerRadiusPx(),e=b.getOuterRadiusPx(),f=b.getStartAngleRadians(),g=b.getEndAngleRadians(),h=c.getInnerRadiusPx(),i=c.getOuterRadiusPx(),j=c.getStartAngleRadians(),k=c.getEndAngleRadians(),l=Math.max(d,h),m=Math.min(e,i)-l;if(m>0){var n=Math.max(f,j),o=Math.min(g,k)-n;return o>0?new a(l,n,m,o):null}return null},a.prototype.containsVertically=function(a){return this._r<=a&&this._r+this._height>a},a.prototype.containsHorizontally=function(a){var b=this.normalizeAngle(a);return this._a<=b&&this._a+this._arc>b},a.prototype.getInnerRadiusPx=function(){return this._r},a.prototype.getHeightPx=function(){return this._height},a.prototype.getOuterRadiusPx=function(){return this._r+this._height},a.prototype.getStartAngleRadians=function(){return this._a},a.prototype.getCenterRadiusPx=function(){return this._r+this._height/2},a.prototype.getEndAngleRadians=function(){return this._a+this._arc},a.prototype.getCenterAngleRadians=function(){return this._a+this._arc/2},a.prototype.getWidthRadians=function(){return this._arc},a.prototype.getOuterCircumferencePx=function(){var a=this.getOuterRadiusPx();return a*this._arc},a.prototype.getInnerCircumferencePx=function(){var a=this.getInnerRadiusPx();return a*this._arc},a.prototype.normalize=function(){this._a=this.normalizeAngle(this._a)},a.prototype.normalizeAngle=function(a){for(;0>a;)a+=2*Math.PI;return a%(2*Math.PI)},a.prototype.permutate=function(){var b=this.getEndAngleRadians(),c=[this];return b>2*Math.PI&&c.push(new a(this._r,this._a-2*Math.PI,this._height,this._arc)),c},a.prototype.overlaps=function(b){return null!=a.intersect(this,b)},a}();a.PolarBounds=b}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){!function(a){a[a.Top=-1]="Top",a[a.Left=-2]="Left",a[a.Bottom=1]="Bottom",a[a.Right=2]="Right",a[a.Undefined=0]="Undefined"}(a.PolarEdge||(a.PolarEdge={}));a.PolarEdge}(b=a.Level||(a.Level={}))}(Poust||(Poust={}));var Poust;!function(a){var b;!function(a){var b;!function(a){var b=function(){function a(a,b,c){this._lineWidth=a,this._strokeStyle=b,this._fillStyle=c}return a.prototype.render=function(a,b){a.strokeStyle=this._strokeStyle,a.fillStyle=this._fillStyle,a.lineWidth=this._lineWidth;var c=b.getBounds(),d=c.getStartAngleRadians(),e=Math.sin(d),f=Math.cos(d),g=c.getEndAngleRadians(),h=Math.sin(g),i=Math.cos(g),j=c.getInnerRadiusPx(),k=c.getOuterRadiusPx();a.beginPath(),a.moveTo(f*k,e*k),a.arc(0,0,k,d,g,!1),a.lineTo(i*j,h*j),a.arc(0,0,j,g,d,!0),a.closePath(),a.fill(),a.stroke()},a}();a.PathEntityRenderer=b}(b=a.Renderer||(a.Renderer={}))}(b=a.Level||(a.Level={}))}(Poust||(Poust={})),window.onload=function(){var a=document.getElementById("canvas"),b=new Poust.Level.Entity.PlayerEntity(Poust.Level.GroupId.Player,24,1,.4);b._bounds=new Poust.Level.PolarBounds(510,Math.PI/2,32,Math.PI/30);var c=a;c.setAttribute("width",""+document.body.clientWidth+"px"),c.setAttribute("height",""+document.body.clientHeight+"px");var d=c.getContext("2d"),e=d.createRadialGradient(0,0,0,0,0,800);e.addColorStop(0,"rgba(255, 0, 255, 0.5)"),e.addColorStop(.1,"rgba(255, 0, 0, 0.5)"),e.addColorStop(.2,"rgba(255, 255, 0, 0.5)"),e.addColorStop(.3,"rgba(0, 255, 0, 0.5)"),e.addColorStop(.4,"rgba(0, 255, 255, 0.5)"),e.addColorStop(.5,"rgba(0, 0, 255, 0.6)"),e.addColorStop(.6,"rgba(255, 255, 255, 0.7)"),e.addColorStop(1,"rgba(255, 255, 255, 0)");for(var f=new Poust.Level.Renderer.PathEntityRenderer(2,"#FFFFFF",e),g=new Poust.Level.LevelState(c,b,.0014,d,f,10),h=0,i=10;i>h;){for(var j=h+1;j>0;){if(j%2!=0){var k=new Poust.Level.AbstractEntity(Poust.Level.GroupId.Terrain);k._bounds=new Poust.Level.PolarBounds(100*(h+1),j*Math.PI*2/(h+1),50,2*Math.PI/(h+1)),k._bounds.normalize(),g.addEntity(k)}j--}h++}g.addEntity(b),g.init(),g.start()};